# Base configuration
base:
  world_size: 1
  iterations: 100 # 60k/21 -> ~2k/epoch -> ~0.05 epoch
  seed: 0
  unwrap: false
  log_dir: /sdf/data/neutrino/icarus/spine/train/mpvmpr_v04/logs/full_chain/uresnet_ppn_calib
  log_step: 1

# IO configuration
io:
  loader:
    batch_size: 32
    shuffle: false
    num_workers: 8
    collate_fn: all
    dataset:
      name: larcv
      file_keys: /sdf/data/neutrino/icarus/sim/mpvmpr_v4/test_file_list.txt
      skip_entry_list: /sdf/data/neutrino/icarus/sim/mpvmpr_v4/icarus_mpvmpr_v04_test_skip_event_list.txt
      schema:
        data:
          parser: sparse3d
          sparse_event_list:
            - sparse3d_reco_cryoE
            - sparse3d_reco_cryoE_chi2
            - sparse3d_reco_cryoE_hit_charge0
            - sparse3d_reco_cryoE_hit_charge1
            - sparse3d_reco_cryoE_hit_charge2
            - sparse3d_reco_cryoE_hit_key0
            - sparse3d_reco_cryoE_hit_key1
            - sparse3d_reco_cryoE_hit_key2
        sources:
          parser: sparse3d
          sparse_event_list:
            - sparse3d_reco_cryoE_cryo
            - sparse3d_reco_cryoE_tpc
          feature_only: true
        seg_label:
          parser: sparse3d
          sparse_event: sparse3d_pcluster_semantics_ghost
        ppn_label:
          parser: particle_points
          sparse_event: sparse3d_pcluster
          particle_event: particle_corrected
          include_point_tagging: false
        clust_label:
          parser: cluster3d
          cluster_event: cluster3d_pcluster
          particle_event: particle_corrected
          sparse_semantics_event: sparse3d_pcluster_semantics
          add_particle_info: true
          clean_data: true
        meta:
          parser: meta
          sparse_event: sparse3d_pcluster
        run_info:
          parser: run_info
          sparse_event: sparse3d_pcluster

# Model configuration
model:
  name: full_chain
  weight_path: /sdf/data/neutrino/icarus/spine/train/mpvmpr_v04/weights/full_chain/uresnet_ppn_calib/snapshot-4[0-9]999.ckpt

  network_input:
    data: data
    sources: sources
    seg_label: seg_label
    clust_label: clust_label
    meta: meta
    run_info: run_info

  loss_input:
    seg_label: seg_label
    ppn_label: ppn_label
    clust_label: clust_label

  modules:
    # General chain configuration
    chain:
      deghosting: uresnet
      charge_rescaling: collection
      segmentation: uresnet
      point_proposal: ppn
      fragmentation: null
      shower_aggregation: null
      shower_primary: null
      track_aggregation: null
      particle_aggregation: null
      inter_aggregation: null
      particle_identification: null
      primary_identification: null
      orientation_identification: null
      calibration: apply

    # Deghosting
    uresnet_deghost:
      num_input: 2
      num_classes: 2
      filters: 32
      depth: 5
      reps: 2
      allow_bias: false
      activation:
        name: lrelu
        negative_slope: 0.33
      norm_layer:
        name: batch_norm
        eps: 0.0001
        momentum: 0.01

    uresnet_deghost_loss:
      balance_loss: false

    # Calibration
    calibration:
      stage: segmentation
      geometry:
        detector: icarus
      gain:
        gain: 82.03 # e-/ADC
      recombination:
        model: mbox
        efield: 0.4938 # kV/cm
        mip_dedx: 2.105168 # MeV/cm
      lifetime:
        lifetime:
          1: 3000 # us
          2: 4000 # us
          3: 8000 # us
        driftv: 0.157565 # cm/us

    # Semantic segmentation + point proposal
    uresnet_ppn:
      uresnet:
        num_input: 1
        num_classes: 5
        filters: 32
        depth: 5
        reps: 2
        allow_bias: false
        activation:
          name: lrelu
          negative_slope: 0.33
        norm_layer:
          name: batch_norm
          eps: 0.0001
          momentum: 0.01

      ppn:
        classify_endpoints: false

    uresnet_ppn_loss:
      uresnet_loss:
        balance_loss: false

      ppn_loss:
        mask_loss: CE
        resolution: 5.0
        restrict_to_clusters: true
