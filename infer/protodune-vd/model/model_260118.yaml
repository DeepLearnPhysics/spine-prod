# ProtoDUNE-VD model configuration
# Revision date: January 18, 2026

__meta__:
  version: "260118"
  date: "2026-01-18"
  description: "ProtoDUNE-VD collection-only model with in-chain calibration, v0 dataset"
  compatible_with:
    base: ">=260118"
    io: ">=260118"
  tags:
    [
      collection-only,
      pre-calibration,
      ppn-restrict,
      grappa-use-closest,
      grouping-through-track,
    ]
  training_set: "v0"

include: model_common.yaml

override:
  # Path to the individual module weights (pre-prod)
  # model.weight_path: TBD
  model.modules.uresnet_deghost.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/full_chain/graph_spice/snapshot-4999.ckpt
  model.modules.uresnet_ppn.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/full_chain/graph_spice/snapshot-4999.ckpt
  model.modules.graph_spice.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/graph_spice/edep/snapshot-14999.ckpt
  model.modules.graph_spice.model_name: ""
  model.modules.grappa_shower.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/grappa_shower/edep/snapshot-9999.ckpt
  model.modules.grappa_shower.model_name: ""
  model.modules.grappa_track.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/grappa_track/edep/snapshot-9999.ckpt
  model.modules.grappa_track.model_name: ""
  model.modules.grappa_inter.weight_path: /sdf/data/neutrino/pdune/spine/train/vd/mpvmpr_v0/weights/grappa_inter/edep_balanced/snapshot-9999.ckpt
  model.modules.grappa_inter.model_name: ""

  # Calibration handled before the semantic segmentation stage
  model.modules.chain.calibration: apply
  model.modules.calibration:
    stage: segmentation
    gain:
      gain: 14.0 # e-/ADC
    recombination:
      model: mbox
      efield: 0.495 # kV/cm
      mip_dedx: 2.105168 # MeV/cm
    lifetime:
      lifetime: 35000 # us
      driftv: 0.157725 # cm/us, derived from efield at T=87.68 (ICARUS fit)

  # Charge rescaling uses collection-only charge
  model.modules.chain.charge_rescaling: collection

  # Older PPN/GrapPA loss settings
  model.modules.uresnet_ppn.ppn.classify_endpoints: false
  model.modules.uresnet_ppn_loss.ppn_loss.restrict_to_clusters: true
  model.modules.grappa_shower_loss.node_loss.use_closest: true

  # Interaction grouping restriction applied
  model.modules.grappa_inter.nodes.grouping_through_track: true
