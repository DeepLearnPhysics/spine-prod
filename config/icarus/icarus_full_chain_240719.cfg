# ICARUS full chain configuration (July 19, 2024 version)
# Latest version with updated weights and settings
include: icarus_base.cfg

override:
  # Path to the v2 model weights
  model.weight_path: /sdf/data/neutrino/icarus/spine/train/mpvmpr_v02/weights/full_chain/default/snapshot-7999.ckpt

  # Include point tagging in PPN label parser
  io.loader.dataset.schema.ppn_label.include_point_tagging: true

  # No calibration applied in the chain, handled in post-processing
  model.modules.chain.calibration: null
  model.modules.calibration: null
  model.network_input-: meta

  post.apply_calibrations:
    gain:
      gain: 77.0777
    recombination:
      efield: 0.4938 # kV/cm
      model: mbox
    lifetime:
      lifetime: 3000
      driftv: 0.157565
    priority: 7

  #  Charge rescaling uses average charge
  model.modules.chain.charge_rescaling: average

  # Older PPN/GrapPA loss settings
  model.modules.uresnet_ppn.ppn.classify_endpoints: true
  model.modules.uresnet_ppn_loss.ppn_loss.restrict_to_clusters: null
  model.modules.grappa_shower_loss.node_loss.use_closest: null

  # Interaction grouping restriction not applied
  model.modules.grappa_inter.nodes.grouping_through_track: null

  # Post-processors related to showers not used in this config
  post-:
    - start_dedx
    - end_dedx
    - time_containment
    - particle_spread
    - particle_threshold
    - shower_conversion_distance
    - shower_start_correction
    - shower_start_merge
    - start_straightness

  # Older post-processor settings
  post.flash_match.legacy: true
  post.flash_match.scaling: 1/350
  post.flash_match.cfg: flashmatch_230930.cfg

  post.direction-: radius

  post.containment-:
    - truth_point_mode
    - exclude_pids
  post.containment.min_particle_sizes:
    0: 25
    1: 25

  post.calo_ke.shower_fudge: 1/0.83
  
  post.shape_logic-: maximum_michel_ke

  post.topology_threshold-: truth_ke_mode
  post.topology_threshold.ke_thresholds:
    4: 50
    default: 25

  post.vertex-: update_orientations
