# ICARUS model configuration
# Revision date: August 12, 2024

__meta__:
  version: "240812"
  date: "2024-08-12"
  description: "ICARUS collection-only model, v2 dataset"
  compatible_with:
    base: ">=240719"
    io: ">=240812"
  tags: [collection-only]
  training_set: "v2"

include: model_common.yaml

override:
  # Path to the v2 collection-only, restricted model weights
  model.weight_path: !download
    url: https://s3df.slac.stanford.edu/data/neutrino/spine/weights/icarus/icarus_co_snapshot_240812.ckpt
    hash: a58b04d656da56a23029c52f6f891fe0c28a82e9e5a55687fd8a114dce1446eb

  # Change the input data to collection-only (for deghosting)
  io.loader.dataset.schema.data.sparse_event_list:
    - sparse3d_reco_cryoE_hit_charge2
    - sparse3d_reco_cryoE_chi2
    - sparse3d_reco_cryoE_hit_charge0
    - sparse3d_reco_cryoE_hit_charge1
    - sparse3d_reco_cryoE_hit_charge2
    - sparse3d_reco_cryoE_hit_key0
    - sparse3d_reco_cryoE_hit_key1
    - sparse3d_reco_cryoE_hit_key2
    - sparse3d_reco_cryoW_hit_charge2
    - sparse3d_reco_cryoW_chi2
    - sparse3d_reco_cryoW_hit_charge0
    - sparse3d_reco_cryoW_hit_charge1
    - sparse3d_reco_cryoW_hit_charge2
    - sparse3d_reco_cryoW_hit_key0
    - sparse3d_reco_cryoW_hit_key1
    - sparse3d_reco_cryoW_hit_key2

  # No calibration applied in the chain, handled in post-processing
  model.modules.chain.calibration: null
  model.modules.calibration: null
  model.network_input-:
    - meta
    - run_info

  # Charge rescaling uses collection-only charge
  model.modules.chain.charge_rescaling: collection

  # Older PPN/GrapPA loss settings
  model.modules.uresnet_ppn.ppn.classify_endpoints: false
  model.modules.uresnet_ppn_loss.ppn_loss.restrict_to_clusters: true
  model.modules.grappa_shower_loss.node_loss.use_closest: false

  # Direction and dE/dx radii settings for GrapPA modules
  model.modules.grappa_shower.node_encoder.dir_max_dist: -1
  model.modules.grappa_shower.node_encoder.dedx_max_dist: -1
  model.modules.grappa_track.node_encoder.dir_max_dist: -1
  model.modules.grappa_track.node_encoder.dedx_max_dist: -1
  model.modules.grappa_inter.node_encoder.dir_max_dist: -1
  model.modules.grappa_inter.node_encoder.dedx_max_dist: -1

  # Interaction grouping restriction not applied
  model.modules.grappa_inter.nodes.grouping_through_track: false
